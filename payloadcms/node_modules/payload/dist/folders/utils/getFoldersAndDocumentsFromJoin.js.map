{"version":3,"sources":["../../../src/folders/utils/getFoldersAndDocumentsFromJoin.ts"],"sourcesContent":["import type { PaginatedDocs } from '../../database/types.js'\nimport type { CollectionSlug } from '../../index.js'\nimport type { Document, PayloadRequest } from '../../types/index.js'\nimport type { FolderOrDocument } from '../types.js'\n\nimport { formatFolderOrDocumentItem } from './formatFolderOrDocumentItem.js'\n\ntype QueryDocumentsAndFoldersResults = {\n  documents: FolderOrDocument[]\n  subfolders: FolderOrDocument[]\n}\ntype QueryDocumentsAndFoldersArgs = {\n  collectionSlug?: CollectionSlug\n  parentFolderID: number | string\n  req: PayloadRequest\n}\nexport async function queryDocumentsAndFoldersFromJoin({\n  collectionSlug,\n  parentFolderID,\n  req,\n}: QueryDocumentsAndFoldersArgs): Promise<QueryDocumentsAndFoldersResults> {\n  const { payload, user } = req\n  const folderCollectionSlugs: string[] = payload.config.collections.reduce<string[]>(\n    (acc, collection) => {\n      if (collection?.folders) {\n        acc.push(collection.slug)\n      }\n      return acc\n    },\n    [],\n  )\n\n  const subfolderDoc = (await payload.find({\n    collection: payload.config.folders.slug,\n    joins: {\n      documentsAndFolders: {\n        limit: 100_000,\n        sort: 'name',\n        where: {\n          relationTo: {\n            in: [\n              payload.config.folders.slug,\n              ...(collectionSlug ? [collectionSlug] : folderCollectionSlugs),\n            ],\n          },\n        },\n      },\n    },\n    limit: 1,\n    overrideAccess: false,\n    req,\n    user,\n    where: {\n      id: {\n        equals: parentFolderID,\n      },\n    },\n  })) as PaginatedDocs<Document>\n\n  const childrenDocs = subfolderDoc?.docs[0]?.documentsAndFolders?.docs || []\n\n  const results: QueryDocumentsAndFoldersResults = childrenDocs.reduce(\n    (acc: QueryDocumentsAndFoldersResults, doc: Document) => {\n      const { relationTo, value } = doc\n      const item = formatFolderOrDocumentItem({\n        folderFieldName: payload.config.folders.fieldName,\n        isUpload: Boolean(payload.collections[relationTo].config.upload),\n        relationTo,\n        useAsTitle: payload.collections[relationTo].config.admin?.useAsTitle,\n        value,\n      })\n\n      if (relationTo === payload.config.folders.slug) {\n        acc.subfolders.push(item)\n      } else {\n        acc.documents.push(item)\n      }\n\n      return acc\n    },\n    {\n      documents: [],\n      subfolders: [],\n    },\n  )\n\n  return results\n}\n"],"names":["formatFolderOrDocumentItem","queryDocumentsAndFoldersFromJoin","collectionSlug","parentFolderID","req","payload","user","folderCollectionSlugs","config","collections","reduce","acc","collection","folders","push","slug","subfolderDoc","find","joins","documentsAndFolders","limit","sort","where","relationTo","in","overrideAccess","id","equals","childrenDocs","docs","results","doc","value","item","folderFieldName","fieldName","isUpload","Boolean","upload","useAsTitle","admin","subfolders","documents"],"mappings":"AAKA,SAASA,0BAA0B,QAAQ,kCAAiC;AAW5E,OAAO,eAAeC,iCAAiC,EACrDC,cAAc,EACdC,cAAc,EACdC,GAAG,EAC0B;IAC7B,MAAM,EAAEC,OAAO,EAAEC,IAAI,EAAE,GAAGF;IAC1B,MAAMG,wBAAkCF,QAAQG,MAAM,CAACC,WAAW,CAACC,MAAM,CACvE,CAACC,KAAKC;QACJ,IAAIA,YAAYC,SAAS;YACvBF,IAAIG,IAAI,CAACF,WAAWG,IAAI;QAC1B;QACA,OAAOJ;IACT,GACA,EAAE;IAGJ,MAAMK,eAAgB,MAAMX,QAAQY,IAAI,CAAC;QACvCL,YAAYP,QAAQG,MAAM,CAACK,OAAO,CAACE,IAAI;QACvCG,OAAO;YACLC,qBAAqB;gBACnBC,OAAO;gBACPC,MAAM;gBACNC,OAAO;oBACLC,YAAY;wBACVC,IAAI;4BACFnB,QAAQG,MAAM,CAACK,OAAO,CAACE,IAAI;+BACvBb,iBAAiB;gCAACA;6BAAe,GAAGK;yBACzC;oBACH;gBACF;YACF;QACF;QACAa,OAAO;QACPK,gBAAgB;QAChBrB;QACAE;QACAgB,OAAO;YACLI,IAAI;gBACFC,QAAQxB;YACV;QACF;IACF;IAEA,MAAMyB,eAAeZ,cAAca,IAAI,CAAC,EAAE,EAAEV,qBAAqBU,QAAQ,EAAE;IAE3E,MAAMC,UAA2CF,aAAalB,MAAM,CAClE,CAACC,KAAsCoB;QACrC,MAAM,EAAER,UAAU,EAAES,KAAK,EAAE,GAAGD;QAC9B,MAAME,OAAOjC,2BAA2B;YACtCkC,iBAAiB7B,QAAQG,MAAM,CAACK,OAAO,CAACsB,SAAS;YACjDC,UAAUC,QAAQhC,QAAQI,WAAW,CAACc,WAAW,CAACf,MAAM,CAAC8B,MAAM;YAC/Df;YACAgB,YAAYlC,QAAQI,WAAW,CAACc,WAAW,CAACf,MAAM,CAACgC,KAAK,EAAED;YAC1DP;QACF;QAEA,IAAIT,eAAelB,QAAQG,MAAM,CAACK,OAAO,CAACE,IAAI,EAAE;YAC9CJ,IAAI8B,UAAU,CAAC3B,IAAI,CAACmB;QACtB,OAAO;YACLtB,IAAI+B,SAAS,CAAC5B,IAAI,CAACmB;QACrB;QAEA,OAAOtB;IACT,GACA;QACE+B,WAAW,EAAE;QACbD,YAAY,EAAE;IAChB;IAGF,OAAOX;AACT"}